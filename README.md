# Cloud Terraform - FactuTable Infrastructure

Este proyecto define la infraestructura completa para la aplicaci√≥n **FactuTable**, un sistema de procesamiento de facturas basado en AWS. La infraestructura est√° construida usando Terraform con un enfoque modular y escalable.

## üìã Tabla de Contenidos

- [Descripci√≥n General](#descripci√≥n-general)
- [Arquitectura](#arquitectura)
- [M√≥dulos](#m√≥dulos)
- [Funciones Lambda](#funciones-lambda)
- [Meta-argumentos y Configuraciones](#meta-argumentos-y-configuraciones)
- [Gu√≠a de Ejecuci√≥n](#gu√≠a-de-ejecuci√≥n)
- [Variables de Configuraci√≥n](#variables-de-configuraci√≥n)
- [Estructura del Proyecto](#estructura-del-proyecto)

## üèóÔ∏è Descripci√≥n General

FactuTable es una aplicaci√≥n serverless que permite:
- **Autenticaci√≥n** mediante AWS Cognito
- **Carga de facturas** con URLs pre-firmadas
- **Procesamiento autom√°tico** de facturas PDF
- **Almacenamiento** en DynamoDB
- **Generaci√≥n de reportes** y descarga de documentos
- **API REST** para gesti√≥n de datos

## üèõÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend SPA  ‚îÇ    ‚îÇ   API Gateway   ‚îÇ    ‚îÇ   Cognito Auth  ‚îÇ
‚îÇ   (S3 Website)  ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (HTTP API)    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (User Pool)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Lambda Layer  ‚îÇ    ‚îÇ   Lambda Funcs  ‚îÇ    ‚îÇ   S3 Buckets    ‚îÇ
‚îÇ   (Dependencies)‚îÇ    ‚îÇ   (Processing)  ‚îÇ    ‚îÇ   (Storage)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DynamoDB      ‚îÇ    ‚îÇ   CloudWatch    ‚îÇ    ‚îÇ   Step Functions ‚îÇ
‚îÇ   (Data Store)  ‚îÇ    ‚îÇ   (Logging)     ‚îÇ    ‚îÇ   (Orchestration)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì¶ M√≥dulos

### 1. M√≥dulo S3 Buckets (`modules/s3_buckets/`)

**Prop√≥sito**: Gestiona buckets S3 con configuraciones espec√≠ficas para diferentes casos de uso.

**Caracter√≠sticas**:
- **Nombres √∫nicos**: Genera nombres √∫nicos usando sufijos aleatorios
- **Configuraci√≥n dual**: Soporte para versionado O hosting web (mutuamente excluyentes)
- **CORS habilitado**: Para comunicaci√≥n con frontend
- **Pol√≠ticas de acceso**: Configuraci√≥n autom√°tica seg√∫n el tipo de bucket

**Recursos creados**:
- `aws_s3_bucket`: Bucket principal
- `aws_s3_bucket_versioning`: Versionado (opcional)
- `aws_s3_bucket_website_configuration`: Hosting web (opcional)
- `aws_s3_bucket_public_access_block`: Control de acceso p√∫blico
- `aws_s3_bucket_policy`: Pol√≠tica de acceso para sitios web

**Variables**:
- `bucket_name`: Nombre base del bucket (m√°x. 56 caracteres)
- `enable_versioning`: Activa versionado
- `enable_website_hosting`: Configura para hosting web
- `tags`: Etiquetas personalizadas

### 2. M√≥dulo Principal (`production/`)

**Prop√≥sito**: Orquesta todos los recursos de la aplicaci√≥n.

**Componentes principales**:
- **Cognito**: Autenticaci√≥n y autorizaci√≥n
- **Lambda Functions**: Procesamiento serverless
- **API Gateway**: Endpoints REST
- **DynamoDB**: Almacenamiento de datos
- **CloudWatch**: Logging y monitoreo

## üîß Funciones Lambda

### 1. `cognito-post-auth`
- **Trigger**: Cognito Post Authentication Hook
- **Prop√≥sito**: Procesamiento post-autenticaci√≥n
- **Runtime**: Python 3.12

### 2. `presigned-url-generator`
- **Trigger**: API Gateway (POST /uploads/presign)
- **Prop√≥sito**: Genera URLs pre-firmadas para carga de archivos
- **Autenticaci√≥n**: JWT (Cognito)
- **Runtime**: Python 3.12

### 3. `invoice-processor`
- **Trigger**: S3 Object Created Event
- **Prop√≥sito**: Procesa facturas PDF autom√°ticamente
- **Runtime**: Python 3.12

### 4. `database-writer`
- **Trigger**: Step Functions
- **Prop√≥sito**: Escribe datos procesados a DynamoDB
- **Variables de entorno**: `TABLE_NAME`
- **Runtime**: Python 3.12

### 5. `report-generator`
- **Trigger**: API Gateway (GET /download)
- **Prop√≥sito**: Genera y sirve reportes
- **Autenticaci√≥n**: JWT (Cognito)
- **Runtime**: Python 3.12

### 6. `invoice-data-updater`
- **Trigger**: API Gateway (PUT /invoices/{id})
- **Prop√≥sito**: Actualiza datos de facturas
- **Autenticaci√≥n**: JWT (Cognito)
- **Runtime**: Python 3.12

### 7. `invoice-data-getter`
- **Trigger**: API Gateway (GET /invoices)
- **Prop√≥sito**: Obtiene listado de facturas
- **Variables de entorno**: `TABLE_NAME`, `INDEX_NAME`
- **Autenticaci√≥n**: JWT (Cognito)
- **Runtime**: Python 3.12

## ‚öôÔ∏è Meta-argumentos y Configuraciones

### `for_each` - Iteraci√≥n de Recursos

```hcl
module "s3_buckets" {
  for_each = var.buckets
  # Crea un bucket por cada entrada en var.buckets
}

module "lambdas" {
  for_each = var.lambda_functions
  # Crea una funci√≥n Lambda por cada entrada en var.lambda_functions
}
```

### `merge()` - Combinaci√≥n de Variables

```hcl
environment_variables = merge(
  # Variables por defecto
  {
    UPLOAD_BUCKET = module.s3_buckets["facturas"].bucket_name
  },
  # Variables de Cognito para todas las lambdas
  {
    COGNITO_CLIENT_ID    = aws_cognito_user_pool_client.app_client.id
    COGNITO_REDIRECT_URI = "${module.http_api.api_endpoint}/prod/auth/callback"
    COGNITO_DOMAIN       = aws_cognito_user_pool_domain.user_pool_domain.domain
    COGNITO_USER_POOL_ID = aws_cognito_user_pool.user_pool.id
  },
  # Variables condicionales
  each.key == "database-writer" ? {
    TABLE_NAME = module.ddb_invoice_jobs.dynamodb_table_id
  } : {}
)
```

### `depends_on` - Dependencias Expl√≠citas

```hcl
resource "aws_s3_bucket_notification" "uploads_trigger" {
  depends_on = [
    aws_lambda_permission.s3_invoke_processor
  ]
}
```

### `count` - Recursos Condicionales

```hcl
resource "aws_s3_bucket_versioning" "this" {
  count  = var.enable_versioning ? 1 : 0
  # Solo se crea si enable_versioning es true
}
```

## üöÄ Gu√≠a de Ejecuci√≥n

### Prerrequisitos

1. **AWS CLI configurado**:
   ```bash
   aws configure
   ```

2. **Terraform instalado** (versi√≥n >= 1.0):
   ```bash
   terraform --version
   ```

3. **Permisos IAM necesarios**:
   - S3: Full access
   - Lambda: Full access
   - API Gateway: Full access
   - Cognito: Full access
   - DynamoDB: Full access
   - CloudWatch: Logs access

### Paso 1: Preparar el Entorno

```bash
# Clonar el repositorio
git clone <repository-url>
cd cloud-terraform

# Navegar al directorio de producci√≥n
cd production
```

### Paso 2: Configurar Variables

Editar `terraform.tfvars` seg√∫n tus necesidades:

```hcl
# Configuraci√≥n de buckets
buckets = {
  facturas = {
    bucket_name_base       = "mi-app-facturas"
    enable_versioning      = true
    enable_website_hosting = false
    content_tag            = "facturas"
  },
  spa = {
    bucket_name_base       = "mi-app-spa"
    enable_versioning      = false
    enable_website_hosting = true
    content_tag            = "spa"
  }
}

# Configuraci√≥n de funciones Lambda
lambda_functions = {
  "cognito-post-auth" = {
    source_path = "../src/lambda-cognito-hook"
    handler     = "main.handler"
    runtime     = "python3.12"
  }
  # ... m√°s funciones
}
```

### Paso 3: Inicializar Terraform

```bash
# Inicializar el directorio de trabajo
terraform init

# Verificar la configuraci√≥n
terraform validate
```

### Paso 4: Planificar el Despliegue

```bash
# Crear un plan de ejecuci√≥n
terraform plan -out=tfplan

# Revisar los recursos que se van a crear
terraform show tfplan
```

### Paso 5: Desplegar la Infraestructura

```bash
# Aplicar los cambios
terraform apply tfplan

# O aplicar directamente
terraform apply
```

### Paso 6: Verificar el Despliegue

```bash
# Ver el estado actual
terraform state list

# Ver outputs importantes
terraform output
```

### Paso 7: Configuraci√≥n Post-Despliegue

1. **Configurar el frontend**:
   ```bash
   # Subir archivos del frontend al bucket SPA
   aws s3 sync ../frontend/ s3://<bucket-spa-name>/
   ```

2. **Configurar permisos IAM** (si es necesario):
   - Agregar pol√≠ticas S3 al rol `LabRole`
   - Configurar permisos DynamoDB

3. **Probar la API**:
   ```bash
   # Obtener el endpoint de la API
   terraform output api_endpoint
   ```

## üìä Variables de Configuraci√≥n

### Variables Principales

| Variable | Tipo | Descripci√≥n | Valor por Defecto |
|----------|------|-------------|-------------------|
| `buckets` | `map(object)` | Configuraci√≥n de buckets S3 | `{}` |
| `lambda_functions` | `map(object)` | Configuraci√≥n de funciones Lambda | `{}` |
| `academy_role` | `string` | Nombre del rol IAM | `"LabRole"` |
| `region` | `string` | Regi√≥n de AWS | `"us-east-1"` |
| `manage_iam` | `bool` | Gestionar roles IAM | `false` |
| `manage_lambda_log_group` | `bool` | Crear grupos de logs | `false` |

### Variables del M√≥dulo S3

| Variable | Tipo | Descripci√≥n | Validaciones |
|----------|------|-------------|--------------|
| `bucket_name` | `string` | Nombre base del bucket | M√°x. 56 caracteres, solo alfanum√©ricos y guiones |
| `enable_versioning` | `bool` | Activar versionado | - |
| `enable_website_hosting` | `bool` | Configurar para hosting web | Mutuamente excluyente con versioning |
| `tags` | `map(string)` | Etiquetas del bucket | - |

## üìÅ Estructura del Proyecto

```
cloud-terraform/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ s3_buckets/           # M√≥dulo reutilizable para buckets S3
‚îÇ       ‚îú‚îÄ‚îÄ main.tf           # Recursos principales
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf      # Variables de entrada
‚îÇ       ‚îú‚îÄ‚îÄ outputs.tf        # Valores de salida
‚îÇ       ‚îú‚îÄ‚îÄ locals.tf         # C√°lculos locales
‚îÇ       ‚îî‚îÄ‚îÄ providers.tf      # Configuraci√≥n de providers
‚îú‚îÄ‚îÄ production/               # Entorno de producci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # Recursos principales
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # Variables del entorno
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars     # Valores de las variables
‚îÇ   ‚îú‚îÄ‚îÄ providers.tf         # Configuraci√≥n de providers
‚îÇ   ‚îî‚îÄ‚îÄ builds/              # Archivos de build
‚îú‚îÄ‚îÄ src/                     # C√≥digo fuente de las funciones Lambda
‚îÇ   ‚îú‚îÄ‚îÄ lambda-cognito-hook/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-database-writer/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-invoice-processor/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-presigned-url-generator/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-report-generator/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-invoice-updater/
‚îÇ   ‚îú‚îÄ‚îÄ lambda-invoice-getter/
‚îÇ   ‚îî‚îÄ‚îÄ lambda-layer.zip     # Dependencias compartidas
‚îú‚îÄ‚îÄ frontend/                # Aplicaci√≥n frontend
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ main.js
‚îÇ   ‚îú‚îÄ‚îÄ style.css
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md               # Este archivo
```

## üîß Comandos √ötiles

### Gesti√≥n de Estado

```bash
# Ver recursos desplegados
terraform state list

# Ver detalles de un recurso
terraform state show aws_s3_bucket.this

# Importar un recurso existente
terraform import aws_s3_bucket.this bucket-name

# Eliminar un recurso del estado
terraform state rm aws_s3_bucket.this
```

### Debugging

```bash
# Habilitar logs detallados
export TF_LOG=DEBUG
terraform apply

# Ver logs de una funci√≥n Lambda
aws logs tail /aws/lambda/function-name --follow
```

### Limpieza

```bash
# Destruir todos los recursos
terraform destroy

# Destruir recursos espec√≠ficos
terraform destroy -target=aws_s3_bucket.this
```

## üö® Consideraciones Importantes

1. **Nombres √∫nicos**: Los buckets S3 requieren nombres globalmente √∫nicos
2. **Permisos IAM**: Algunos entornos (como AWS Academy) tienen restricciones
3. **Costos**: Monitorear el uso de recursos para evitar costos inesperados
4. **Regiones**: Asegurar que todos los recursos est√©n en la misma regi√≥n
5. **Dependencias**: Algunos recursos requieren configuraci√≥n manual post-despliegue

## üìû Soporte

Para problemas o preguntas:
1. Revisar los logs de CloudWatch
2. Verificar la configuraci√≥n de permisos IAM
3. Consultar la documentaci√≥n de AWS
4. Revisar el estado de Terraform con `terraform state list`

---

**Nota**: Este proyecto est√° dise√±ado para entornos de aprendizaje y desarrollo. Para producci√≥n, considerar implementar mejores pr√°cticas de seguridad, monitoreo y respaldo.
